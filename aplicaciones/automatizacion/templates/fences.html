{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>agrotikos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    body {
      background-color: #f2f4f7;
      background-size: cover; background-position: center; background-repeat: no-repeat;
    }
    #map { height: 70vh; border-radius: 12px; }
    .legend { background: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.12);}    
    .cow-icon { font-size: 22px; line-height: 22px; }
    .cow-marker { display:flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:50%; font-size:18px; box-shadow: 0 2px 6px rgba(0,0,0,0.25); }
    .cow-marker.in { background:#dcfce7; border:2px solid #22c55e; color:#166534; }
    .cow-marker.out { background:#fee2e2; border:2px solid #ef4444; color:#991b1b; }
    .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .status-dot.in { background:#22c55e; }
    .status-dot.out { background:#ef4444; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">agrotikos</a>
      <div class="collapse navbar-collapse"></div>
      <form action="/inicio" method="post" class="d-flex">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary">Volver al portal</button>
      </form>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-12 col-lg-9 mb-3">
        <div class="card frosted">
          <div class="card-body">
            <h5 class="card-title mb-2"><i class="fa-solid fa-map-location-dot me-2"></i>Geocerca activa: Lote <span id="lotName">{{ lote|default:'A' }}</span></h5>
            <p class="card-text muted">Sitio: <span id="siteName">Valle del Cauca, CO</span>. Visualización de posiciones de ganado y verificación de permanencia dentro de la geocerca.</p>
            <div id="map"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-3">
        <div class="card frosted mb-3">
          <div class="card-body">
            <h6 class="card-title">Seleccionar lote</h6>
            <div class="d-flex gap-2">
              <form method="get">
                <input type="hidden" name="lote" value="A" />
                <button type="submit" class="btn btn-primary {% if lote == 'A' %}disabled{% endif %}">Lote A</button>
              </form>
              <form method="get">
                <input type="hidden" name="lote" value="B" />
                <button type="submit" class="btn btn-secondary {% if lote == 'B' %}disabled{% endif %}">Lote B</button>
              </form>
            </div>
          </div>
        </div>
        <div class="card frosted mb-3">
          <div class="card-body">
            <h6 class="card-title">Resumen</h6>
            <div class="d-flex align-items-center justify-content-between mb-2">
              <span><span class="status-dot in"></span>Dentro de geocerca</span>
              <span class="fw-semibold" id="insideCount">0</span>
            </div>
            <div class="d-flex align-items-center justify-content-between">
              <span><span class="status-dot out"></span>Fuera de geocerca</span>
              <span class="fw-semibold" id="outsideCount">0</span>
            </div>
            <hr>
            <div class="small muted">Ãšltima actualización: <span id="lastUpdate">€”</span></div>
          </div>
        </div>
        <div class="card frosted mb-3">
          <div class="card-body">
            <h6 class="card-title">Estado de animales</h6>
            <ul class="mb-0" id="statusList"></ul>
          </div>
        </div>
        <div class="card frosted">
          <div class="card-body">
            <h6 class="card-title">Leyenda</h6>
            <div class="legend">
              <div><span class="me-2">ðŸ„</span>Vaca</div>
              <div><span class="me-2" style="display:inline-block;width:12px;height:12px;background:#22c55e;border-radius:3px;"></span> Geocerca</div>
              <div><span class="me-2" style="display:inline-block;width:12px;height:12px;background:#ef4444;border-radius:3px;"></span> Fuera de geocerca</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // Lote activo desde servidor
    const activeLot = "{{ lote|default:'A' }}";

    // Definir centro segÃºn lote
    let center, delta, siteText;
    if (activeLot === 'B') {
      center = [3.4050, -76.1200]; // otra zona rural (Palmira - El Bolo)
      delta = 0.006;
      siteText = 'Palmira (El Bolo), Valle del Cauca, CO';
    } else {
      center = [3.4206, -76.1542]; // Pradera, zona rural
      delta = 0.006;
      siteText = 'Pradera, Valle del Cauca (zona rural), CO';
    }

    // Corrimiento global hacia el este (40 km)
    function kmToDegLng(latDeg, km){
      const rad = Math.PI/180;
      const kmPerDeg = 111.32 * Math.cos(latDeg * rad);
      return km / kmPerDeg;
    }
    const SHIFT_KM_EAST = 40;
    center = [center[0], center[1] + kmToDegLng(center[0], SHIFT_KM_EAST)];

    // Escribir sitio dinámicamente
    document.addEventListener('DOMContentLoaded', () => {
      const s = document.getElementById('siteName');
      if (s) s.textContent = siteText;
    });

    // Definir un cuadro (aprox. cuadrado en grados) alrededor del centro
    const minLat = center[0] - delta;
    const maxLat = center[0] + delta;
    const minLng = center[1] - delta;
    const maxLng = center[1] + delta;

    const map = L.map('map').setView(center, 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Dibujar un rectángulo (cuadro) como geocerca
    const bounds = [[minLat, minLng], [maxLat, maxLng]];
    const fence = L.rectangle(bounds, { color: '#22c55e', weight: 2, fillOpacity: 0.08 }).addTo(map);

    // Vacas simuladas alrededor del centro
    // Generar vacas segÃºn lote
    let cows;
    if (activeLot === 'B') {
      // 4 dentro + 3 fuera
      cows = [
        { id: 'Vaca-01', pos: [minLat + (delta*0.3), minLng + (delta*0.3)] },
        { id: 'Vaca-02', pos: [minLat + (delta*0.6), minLng + (delta*0.5)] },
        { id: 'Vaca-03', pos: [minLat + (delta*0.7), minLng + (delta*0.8)] },
        { id: 'Vaca-04', pos: [minLat + (delta*0.4), minLng + (delta*0.7)] },
        // Fuera: NE, SO y SE
        { id: 'Vaca-05', pos: [maxLat + (delta*0.25), maxLng + (delta*0.25)] },
        { id: 'Vaca-06', pos: [minLat - (delta*0.25), minLng - (delta*0.25)] },
        { id: 'Vaca-07', pos: [minLat - (delta*0.2), maxLng + (delta*0.3)] },
      ];
    } else {
      // Lote A: 6 dentro + 1 fuera (NE)
      cows = [
        { id: 'Vaca-01', pos: [minLat + (delta*0.3), minLng + (delta*0.3)] },
        { id: 'Vaca-02', pos: [minLat + (delta*0.6), minLng + (delta*0.5)] },
        { id: 'Vaca-03', pos: [minLat + (delta*0.7), minLng + (delta*0.8)] },
        { id: 'Vaca-04', pos: [minLat + (delta*0.4), minLng + (delta*0.7)] },
        { id: 'Vaca-05', pos: [minLat + (delta*0.8), minLng + (delta*0.2)] },
        { id: 'Vaca-06', pos: [minLat + (delta*0.5), minLng + (delta*0.4)] },
        { id: 'Vaca-07', pos: [maxLat + (delta*0.2), maxLng + (delta*0.2)] },
      ];
    }

    // Helper: punto dentro del rectángulo
    function pointInRect([lat, lng]) {
      return lat >= minLat && lat <= maxLat && lng >= minLng && lng <= maxLng;
    }

    const statusList = document.getElementById('statusList');
    const insideCountEl = document.getElementById('insideCount');
    const outsideCountEl = document.getElementById('outsideCount');
    const lastUpdateEl = document.getElementById('lastUpdate');

    let insideCount = 0, outsideCount = 0;

    cows.forEach(cow => {
      const inside = pointInRect(cow.pos);
      inside ? insideCount++ : outsideCount++;

      const icon = L.divIcon({
        className: '',
        html: `<div class="cow-marker ${inside ? 'in' : 'out'}">ðŸ„</div>`,
        iconSize: [28, 28],
        iconAnchor: [14, 14]
      });
      const marker = L.marker(cow.pos, { icon }).addTo(map);
      marker.bindPopup(`<b>${cow.id}</b><br>${inside ? 'Dentro de geocerca' : '<span style="color:#ef4444">Fuera de geocerca</span>'}`);

      const li = document.createElement('li');
      li.innerHTML = `<span class="status-dot ${inside ? 'in' : 'out'}"></span>${cow.id}: ${inside ? '<span class="text-success">Dentro</span>' : '<span class="text-danger">Fuera</span>'}`;
      statusList.appendChild(li);
    });

    insideCountEl.textContent = insideCount;
    outsideCountEl.textContent = outsideCount;
    lastUpdateEl.textContent = new Date().toLocaleString('es-CO');

    // Ajustar mapa a la geocerca
    map.fitBounds(fence.getBounds().pad(0.2));
  </script>
</body>
</html>
