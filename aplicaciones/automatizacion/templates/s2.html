{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>agrotikos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js">


    </script>
    <link rel="stylesheet" href="{% static 'css/app.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <style>
        body {
      background-color: #f2f4f7;
            /* Reemplaza 'ruta/a/tu/imagen.jpg' con la ruta a tu imagen de fondo */
            background-size: cover;
            /* La imagen de fondo cubrirá todo el cuerpo */
            background-position: center;
            /* Centra la imagen de fondo */
            background-repeat: no-repeat;
            /* Evita que la imagen de fondo se repita */
            /*transform: scale(1.15); /* Escala toda la página en un 25% */
        }

        .navbar {
            background-color: #343a40;
        }

        .navbar-brand {
            color: #fff !important;
        }

        .navbar-nav .nav-link {
            color: #ffffff !important;
        }

        .container {
            max-width: 960px;
        }

        .table th,
        .table td {
            padding: .75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
        }

        .table thead th {
            vertical-align: bottom;
            border-bottom: 2px solid #dee2e6;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .row {
            --bs-gutter-x: 0;
        }

        .card {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            margin: 10px;
        }


        @media (min-width: 768px) {
            .col-md-6 {
                | width: 50%;
                max-width: 50%;
            }
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            border-radius: 20px;
            margin: 9px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .input-group {
            width: 360px;

            margin: 9px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
    </style>
</head>


<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">agrotikos</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <form action="/inicio" method="post">
                        {% csrf_token %}
                        <button id="btn-monitoreo" type="submit" class="btn btn-primary">Inicio</button>
                      </form>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
      <div class="container-glass content-pad">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <h2 class="mb-0">Sensores del cultivo</h2>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary btn-sm sensor-btn" data-sensor="humedad_suelo">Humedad suelo</button>
            <button class="btn btn-primary btn-sm sensor-btn" data-sensor="ph">pH cultivo</button>
            <button class="btn btn-primary btn-sm sensor-btn" data-sensor="temp_suelo">Temp. suelo</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="co2">CO2</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="oxigeno">Oxi­geno</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="amoniaco">Amoniaco</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="uv">Luz UV</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="presion">Presion</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="luminosidad">Luminosidad</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="lluvia">Lluvia</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="humedad_aire">Humedad aire</button>
            <button class="btn btn-secondary btn-sm sensor-btn" data-sensor="temp_aire">Temp. aire</button>
          </div>
        </div>
        <hr>
        <div class="row g-3">
          <div class="col-12 col-lg-8">
            <div class="card frosted">
              <div class="card-body">
                <h5 class="card-title mb-2"><span id="chartTitle">Promedios del cultivo (ultimas 12 h)</span></h5>
                <canvas id="sensorChart" height="120"></canvas>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="card frosted mb-3">
              <div class="card-body">
                <h6 class="card-title">Resumen</h6>
                <div class="d-flex justify-content-between"><span>Promedio</span><span id="statAvg">€”</span></div>
                <div class="d-flex justify-content-between"><span>Minimo</span><span id="statMin">€”</span></div>
                <div class="d-flex justify-content-between"><span>Maximo</span><span id="statMax">€”</span></div>
                <div class="d-flex justify-content-between"><span>Ultimo</span><span id="statLast">€”</span></div>
              </div>
            </div>
            <div class="small muted">Sugerencia: selecciona un sensor para ver su serie temporal. Sin selección se muestran promedios.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="container mt-4">
      <div class="card frosted">
        <div class="card-body">
          <h5 class="card-title mb-2"><i class="fa-solid fa-map-location-dot me-2"></i>Mapa de sensores</h5>
          <div id="fieldMap" style="height:380px;border-radius:12px;"></div>
        </div>
      </div>
      <div class="card frosted mt-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <h6 class="card-title mb-0">Lecturas del sensor: <span id="selectedInfo" class="fw-semibold">—</span></h6>
            <small class="muted">Última actualización: <span id="selectedAt">—</span></small>
          </div>
          <div class="table-responsive mt-2">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr><th>Parámetro</th><th>Valor</th></tr>
              </thead>
              <tbody id="sensorReadings">
                <tr><td colspan="2" class="muted">Selecciona un sensor en el mapa para ver todas sus lecturas.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Mapa de sensores: cada sensor mide TODOS los parámetros. Al hacer clic, muestra todas sus lecturas.
      window.addEventListener('load', function(){
        if(!window.L) return;
        var mapEl = document.getElementById('fieldMap');
        if(!mapEl) return;

        function rr(min,max,dec=2){ return +(Math.random()*(max-min)+min).toFixed(dec); }
        function buildSensorData(){
          // Valores realistas para cultivo de arroz
          return {
            humedad_suelo: rr(80,95),              // %
            ph: rr(5.5,6.5),                       // pH
            temp_suelo: rr(24,30),                 // °C
            co2: rr(420,800,0),                    // ppm
            oxigeno: rr(20.5,21.0,2),              // %
            amoniaco: rr(0,2,2),                   // ppm
            uv: rr(0,9,2),                         // índice UV
            presion: rr(1008,1015,1),              // hPa
            luminosidad: rr(30,80,2),              // %
            lluvia: rr(0,8,1),                     // mm/h
            humedad_aire: rr(70,95,1),             // %
            temp_aire: rr(26,34,1),                // °C
          };
        }

        var center = [3.4206, -76.1542];
        var map = L.map('fieldMap').setView(center, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
        var delta = 0.0015;
        var bounds = [[center[0]-delta, center[1]-delta],[center[0]+delta, center[1]+delta]];
        L.rectangle(bounds, { color: '#22c55e', weight: 1, fillOpacity: 0.05 }).addTo(map);

        // Simula 6 nodos de sensores en el lote
        window.sensors = [
          { id:'Nodo-01', pos:[center[0]+0.0006, center[1]-0.0008] },
          { id:'Nodo-02', pos:[center[0]-0.0004, center[1]-0.0006] },
          { id:'Nodo-03', pos:[center[0]+0.0005, center[1]+0.0005] },
          { id:'Nodo-04', pos:[center[0],        center[1]+0.0009] },
          { id:'Nodo-05', pos:[center[0]-0.0002, center[1]+0.0004] },
          { id:'Nodo-06', pos:[center[0]-0.0007, center[1]+0.0001] },
        ].map(function(s){ s.data = buildSensorData(); return s; });

        function formatValue(key, val){
          switch(key){
            case 'humedad_suelo': return val+' %';
            case 'ph': return val+'';
            case 'temp_suelo': return val+' °C';
            case 'co2': return val+' ppm';
            case 'oxigeno': return val+' %';
            case 'amoniaco': return val+' ppm';
            case 'uv': return val+'';
            case 'presion': return val+' hPa';
            case 'luminosidad': return val+' %';
            case 'lluvia': return (val>0? val+' mm/h':'No');
            case 'humedad_aire': return val+' %';
            case 'temp_aire': return val+' °C';
          }
          return val;
        }

        function renderSensorPanel(sensor){
          var infoEl = document.getElementById('selectedInfo');
          var atEl = document.getElementById('selectedAt');
          var tbody = document.getElementById('sensorReadings');
          if(infoEl) infoEl.textContent = sensor.id;
          if(atEl) atEl.textContent = new Date().toLocaleString('es-CO');
          if(!tbody) return;
          var order = [
            ['Datos del suelo',''],
            ['Humedad del suelo','humedad_suelo'],
            ['pH del cultivo','ph'],
            ['Temperatura del suelo','temp_suelo'],
            ['Datos del exterior',''],
            ['CO2','co2'],
            ['Oxígeno','oxigeno'],
            ['Amoniaco','amoniaco'],
            ['Luz ultravioleta','uv'],
            ['Presión barométrica','presion'],
            ['Luminosidad','luminosidad'],
            ['Lluvia','lluvia'],
            ['Humedad aire','humedad_aire'],
            ['Temperatura aire','temp_aire'],
          ];
          var html = '';
          order.forEach(function(item){
            if(!item[1]){ html += '<tr><td colspan="2"><strong>'+item[0]+'</strong></td></tr>'; return; }
            var k = item[1]; var label = item[0]; var val = formatValue(k, sensor.data[k]);
            html += '<tr><td>'+label+'</td><td><span class="fw-semibold">'+val+'</span></td></tr>';
          });
          tbody.innerHTML = html;
        }

        window.selectedSensor = null;
        window.selectSensor = function(sensor){ window.selectedSensor = sensor; renderSensorPanel(sensor); };

        window.sensors.forEach(function(s){
          var marker = L.marker(s.pos).addTo(map).bindPopup(s.id);
          marker.on('click', function(){
            window.selectSensor(s);
          });
        });
        map.fitBounds(bounds);
      });
    </script>

    <h1 class="text-center mt-4">Datos promedio del suelo</h1>
    <div class="container">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-droplet fa-lg"></i></div>
              <div class="fw-semibold">Humedad del suelo</div>
              <div class="display-6"><span id="kpi_hs">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-vial fa-lg"></i></div>
              <div class="fw-semibold">pH del cultivo</div>
              <div class="display-6"><span id="kpi_ph">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-temperature-three-quarters fa-lg"></i></div>
              <div class="fw-semibold">Temperatura del suelo</div>
              <div class="display-6"><span id="kpi_ts">—</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <h1 class="text-center mt-4">Datos promedio del exterior</h1>
    <div class="container">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-cloud fa-lg"></i></div>
              <div class="fw-semibold">CO2</div>
              <div class="display-6"><span id="kpi_co2">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-wind fa-lg"></i></div>
              <div class="fw-semibold">Oxígeno</div>
              <div class="display-6"><span id="kpi_o2">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-triangle-exclamation fa-lg"></i></div>
              <div class="fw-semibold">Amoniaco</div>
              <div class="display-6"><span id="kpi_nh3">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-sun fa-lg"></i></div>
              <div class="fw-semibold">Luz ultravioleta</div>
              <div class="display-6"><span id="kpi_uv">—</span></div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-gauge fa-lg"></i></div>
              <div class="fw-semibold">Presión barométrica</div>
              <div class="display-6"><span id="kpi_pr">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-regular fa-lightbulb fa-lg"></i></div>
              <div class="fw-semibold">Luminosidad</div>
              <div class="display-6"><span id="kpi_lux">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-cloud-showers-heavy fa-lg"></i></div>
              <div class="fw-semibold">Lluvia</div>
              <div class="display-6"><span id="kpi_rain">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-water fa-lg"></i></div>
              <div class="fw-semibold">Humedad aire</div>
              <div class="display-6"><span id="kpi_ha">—</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card frosted h-100">
            <div class="card-body text-center">
              <div class="mb-1"><i class="fa-solid fa-temperature-high fa-lg"></i></div>
              <div class="fw-semibold">Temperatura aire</div>
              <div class="display-6"><span id="kpi_ta">—</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
        <h1 class="text-center mt-4"></h1>
        <div class="container">
            <form action="/get_data_sensor" method="post" class="d-flex justify-content-center">
                {% csrf_token %}
                <button id="btn-datos-cultivo" type="submit" class="btn btn-primary">Actualizar</button>
            </form>
            <form action="/inicio" method="post" class="d-flex justify-content-center">
                {% csrf_token %}
                <button id="btn-datos-cultivo" type="submit" class="btn btn-primary">Regresar</button>
            </form>

        </div>

        <script>
            // Aquí debes reemplazar los datos de ejemplo con tus datos reales
            var humedadData = {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                datasets: [{
                    label: 'Humedad del suelo',
                    data: [12, 19, 3, 5, 2, 3],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };

            var Humedad_airedata = {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                datasets: [{
                    label: 'Ph del cultivo',
                    data: [12, 13, 11, 12, 12, 12],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };
            var Temperatura_airedata = {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                datasets: [{
                    label: 'Ph del cultivo',
                    data: [2, 3, 5, 7, 8, 10],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };
            var phData = {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                datasets: [{
                    label: 'Ph del cultivo',
                    data: [2, 3, 5, 7, 8, 10],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };

            var temperaturaData = {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                datasets: [{
                    label: 'Temperatura del suelo',
                    data: [33, 231, 232, 23, 24, 25],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };
            var Amoniacodata = {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                datasets: [{
                    label: 'Temperatura del suelo',
                    data: [20, 121, 22, 123, 24, 25],
                    fill: false,
                    borderColor: 'rgb(75, 199, 192)',
                    tension: 0.1
                }]
            };
            var CO2data = {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                datasets: [{
                    label: 'Temperatura del suelo',
                    data: [3, 21, 12, 23, 24, 15],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };
            var Oxigenodata = {
                labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                datasets: [{
                    label: 'Temperatura del suelo',
                    data: [270, 271, 272, 273, 274, 275],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };

            var humedadChart = new Chart(document.getElementById('humedadChart'), {
                type: 'line',
                data: humedadData,
            });

            var phChart = new Chart(document.getElementById('phChart'), {
                type: 'line',
                data: phData,
            });

            var temperaturaChart = new Chart(document.getElementById('temperaturaChart'), {
                type: 'line',
                data: temperaturaData,
            });

        </script>
<script>
// Panel interactivo de sensores (demo arroz)
function lastHoursLabels(n=12){const out=[];const now=new Date();for(let i=n-1;i>=0;i--){const d=new Date(now.getTime()-i*3600*1000);out.push(d.getHours().toString().padStart(2,'0')+':00');}return out;}
function randRange(min,max){ return +(Math.random()*(max-min)+min).toFixed(2); }
function series(n, min, max){ return Array.from({length:n},()=>randRange(min,max)); }
const labelsInteractive = lastHoursLabels(12);
const ds = {
  humedad_suelo: { label: 'Humedad del suelo (%)', unit:'%', data: series(12, 80, 95), color: '#10b981' },
  ph:            { label: 'pH del cultivo', unit:'',    data: series(12, 5.5, 6.5), color: '#8b5cf6' },
  temp_suelo:    { label: 'Temperatura del suelo (°C)', unit:'°C', data: series(12, 24, 30), color: '#f59e0b' },
  co2:           { label: 'CO2 (ppm)', unit:'ppm', data: series(12, 420, 800), color: '#0ea5e9' },
  oxigeno:       { label: 'Oxígeno (%)', unit:'%', data: series(12, 20.5, 21.0), color: '#22c55e' },
  amoniaco:      { label: 'Amoniaco (ppm)', unit:'ppm', data: series(12, 0, 2), color: '#ef4444' },
  uv:            { label: 'Índice UV', unit:'', data: series(12, 0, 9), color: '#e11d48' },
  presion:       { label: 'Presión (hPa)', unit:'hPa', data: series(12, 995, 1015), color: '#64748b' },
  luminosidad:   { label: 'Luminosidad (%)', unit:'%', data: series(12, 30, 100), color: '#06b6d4' },
  lluvia:        { label: 'Lluvia (mm/h)', unit:'mm/h', data: series(12, 0, 8), color: '#3b82f6' },
  humedad_aire:  { label: 'Humedad del aire (%)', unit:'%', data: series(12, 70, 95), color: '#22c55e' },
  temp_aire:     { label: 'Temperatura del aire (°C)', unit:'°C', data: series(12, 26, 34), color: '#f97316' },
};
function stats(arr){const avg=(arr.reduce((a,b)=>a+b,0)/arr.length);const min=Math.min(...arr), max=Math.max(...arr), last=arr[arr.length-1];return {avg:+avg.toFixed(2),min:+min.toFixed(2),max:+max.toFixed(2),last:+last.toFixed(2)};}
function updateQuickKPIs(){try{const uv = stats(ds.uv.data).last;const p = stats(ds.presion.data).last;const l = stats(ds.luminosidad.data).last;const rain = stats(ds.lluvia.data).last;document.getElementById('valor1').textContent = uv + '';document.getElementById('valor2').textContent = p + ' hPa';document.getElementById('valor3').textContent = l + ' %';document.getElementById('valor4').textContent = (rain>0? (rain.toFixed(1)+' mm/h') : 'No');}catch(e){}}
(function initInteractive(){
  const canvas=document.getElementById('sensorChart');
  if(!canvas){updateQuickKPIs();return;}
  const ctx=canvas.getContext('2d');
  let mainChart=new Chart(ctx,{type:'line',data:{labels:labelsInteractive,datasets:[{label:'Promedios del cultivo',data: ds.humedad_suelo.data.map((_,i)=>+(((ds.humedad_suelo.data[i]/100)*50)+((ds.temp_suelo.data[i]/40)*25)+((ds.humedad_aire.data[i]/100)*25)).toFixed(2)),borderColor:'#2563eb',tension:0.2,fill:false}]},options:{responsive:true,scales:{y:{beginAtZero:false}}}});

  function setStatsDisplay(s, u){
    const A=document.getElementById('statAvg'); if(!A) return;
    A.textContent=s.avg+(u?' '+u:'');
    document.getElementById('statMin').textContent=s.min+(u?' '+u:'');
    document.getElementById('statMax').textContent=s.max+(u?' '+u:'');
    document.getElementById('statLast').textContent=s.last+(u?' '+u:'');
  }

  function updateMainChartFor(key){
    const d=ds[key]; if(!d) return;
    const s=stats(d.data);
    mainChart.data.labels=labelsInteractive;
    mainChart.data.datasets=[{label:d.label,data:d.data,borderColor:d.color,tension:0.2,fill:false}];
    document.getElementById('chartTitle').textContent=d.label+' (últimas 12 h)';
    mainChart.update();
    setStatsDisplay(s,d.unit);
  }

  function regenSensor(key){
    switch(key){
      case 'humedad_suelo': ds.humedad_suelo.data = series(12,80,95); break;
      case 'ph':            ds.ph.data            = series(12,5.5,6.5); break;
      case 'temp_suelo':    ds.temp_suelo.data    = series(12,24,30); break;
      case 'co2':           ds.co2.data           = series(12,420,800); break;
      case 'oxigeno':       ds.oxigeno.data       = series(12,20.5,21.0); break;
      case 'amoniaco':      ds.amoniaco.data      = series(12,0,2); break;
      case 'uv':            ds.uv.data            = series(12,0,9); break;
      case 'presion':       ds.presion.data       = series(12,995,1015); break;
      case 'luminosidad':   ds.luminosidad.data   = series(12,30,100); break;
      case 'lluvia':        ds.lluvia.data        = series(12,0,8); break;
      case 'humedad_aire':  ds.humedad_aire.data  = series(12,70,95); break;
      case 'temp_aire':     ds.temp_aire.data     = series(12,26,34); break;
    }
  }

  function regenerateInteractiveData(){
    Object.keys(ds).forEach(regenSensor);
    updateQuickKPIs();
    updateAverageKPIs();
    // Si hay un sensor activo, actualizarlo; si no, recalc promedios
    const activeBtn = document.querySelector('.sensor-btn.active');
    if(activeBtn){
      updateMainChartFor(activeBtn.dataset.sensor);
    } else {
      const agg = ds.humedad_suelo.data.map((_,i)=>+(((ds.humedad_suelo.data[i]/100)*50)+((ds.temp_suelo.data[i]/40)*25)+((ds.humedad_aire.data[i]/100)*25)).toFixed(2));
      mainChart.data.datasets=[{label:'Promedios del cultivo', data: agg, borderColor:'#2563eb', tension:0.2, fill:false}];
      mainChart.update();
      setStatsDisplay(stats(agg),'');
    }
  }

  // Listeners de botones de sensores
  document.querySelectorAll('.sensor-btn').forEach(b=>b.addEventListener('click',e=>{
    document.querySelectorAll('.sensor-btn').forEach(bb=>bb.classList.remove('active'));
    e.currentTarget.classList.add('active');
    updateMainChartFor(e.currentTarget.dataset.sensor);
  }));

  // Interceptar el formulario de Actualizar para simular nueva toma de datos
  const forms = Array.from(document.getElementsByTagName('form'));
  const updateForm = forms.find(f=> (f.getAttribute('action')||'').includes('/get_data_sensor'));
  if(updateForm){ updateForm.addEventListener('submit', (ev)=>{ ev.preventDefault(); regenerateInteractiveData(); }); }

  // Inicializar
  updateQuickKPIs();
  const agg = ds.humedad_suelo.data.map((_,i)=>+(((ds.humedad_suelo.data[i]/100)*50)+((ds.temp_suelo.data[i]/40)*25)+((ds.humedad_aire.data[i]/100)*25)).toFixed(2));
  setStatsDisplay(stats(agg),'');
  updateAverageKPIs();
})();

// KPIs promedio con alertas
function updateAverageKPIs(){
  function avg(arr){return +(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2)}
  function setKPI(id, value, unit, isAlert){
    const el=document.getElementById(id); if(!el) return; el.textContent = value + (unit? ' '+unit:'');
    el.classList.remove('text-danger','text-success');
    el.classList.add(isAlert? 'text-danger' : 'text-success');
  }
  // calcular promedios
  const a_hs = avg(ds.humedad_suelo.data);
  const a_ph = avg(ds.ph.data);
  const a_ts = avg(ds.temp_suelo.data);
  const a_co2 = avg(ds.co2.data);
  const a_o2 = avg(ds.oxigeno.data);
  const a_nh3 = avg(ds.amoniaco.data);
  const a_uv = avg(ds.uv.data);
  const a_pr = avg(ds.presion.data);
  const a_lux = avg(ds.luminosidad.data);
  const a_rain = avg(ds.lluvia.data);
  const a_ha = avg(ds.humedad_aire.data);
  const a_ta = avg(ds.temp_aire.data);

  // umbrales (aprox) para arroz
  setKPI('kpi_hs', a_hs.toFixed(0), '%', (a_hs<75 || a_hs>98));
  setKPI('kpi_ph', a_ph.toFixed(2), '', (a_ph<5.5 || a_ph>6.8));
  setKPI('kpi_ts', a_ts.toFixed(1), '°C', (a_ts<24 || a_ts>32));

  setKPI('kpi_co2', a_co2.toFixed(0), 'ppm', (a_co2>900));
  setKPI('kpi_o2', a_o2.toFixed(2), '%', (a_o2<20.5 || a_o2>21.1));
  setKPI('kpi_nh3', a_nh3.toFixed(2), 'ppm', (a_nh3>1.5));
  setKPI('kpi_uv', a_uv.toFixed(2), '', (a_uv>8));
  setKPI('kpi_pr', a_pr.toFixed(1), 'hPa', (a_pr<995 || a_pr>1018));
  setKPI('kpi_lux', a_lux.toFixed(2), '%', false);
  setKPI('kpi_rain', (a_rain>0? a_rain.toFixed(1):0), 'mm/h', false);
  setKPI('kpi_ha', a_ha.toFixed(0), '%', false);
  setKPI('kpi_ta', a_ta.toFixed(1), '°C', (a_ta<24 || a_ta>35));
}
</script>
</body>

</html>
